// argocd/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-server
  namespace: management
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      location /.well-known/acme-challenge/ {
          auth_basic off;
          allow all;
          default_type "text/plain";
          return 200 "acme-challenge";
      }
    cert-manager.io/cluster-issuer: "http01-clusterissuer"
spec:
  ingressClassName: nginx
  rules:
    - host: argocd.6degrees.com.sa
      http:
        paths:
          - path: /.well-known/acme-challenge/
            pathType: Prefix
            backend:
              service:
                name: argocd-server
                port:
                  number: 80
          - path: /
            pathType: Prefix
            backend:
              service:
                name: argocd-server
                port:
                  number: 80


// argocd/values.yaml
server:
  service:
    type: ClusterIP
    ports:
      - name: http
        port: 80
        targetPort: 8080
  ingress:
    enabled: false
  config:
    resource.customizations: |
      argoproj.io/Application:
        health.lua: |
          hs = {}
          hs.status = "Healthy"
          hs.message = "Custom health check passed"
          return hs


// external/external-lb.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: external-lb-config
  namespace: cattle-system
data:
  external-ip: "143.42.223.153"


// helmfile.yaml


// namespaces/management.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: management

// rancher/cert-manager/certificate.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ .Values.certificateName }}
  namespace: {{ .Values.namespace }}
spec:
  dnsNames:
  - {{ .Values.dnsName }}
  issuerRef:
    name: {{ .Values.issuerName }}
    kind: ClusterIssuer
    group: cert-manager.io
  secretName: {{ .Values.secretName }}


// rancher/cert-manager/clusterissuer.yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: http01-clusterissuer
spec:
  acme:
    email: mohannad.otaibi@gmail.com
    privateKeySecretRef:
      name: http01-clusterissuer-secret
    server: https://acme-v02.api.letsencrypt.org/directory
    solvers:
    - http01:
        ingress:
          class: nginx


// rancher/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-ingress-rancher
  namespace: cattle-system
  annotations:
    cert-manager.io/cluster-issuer: http01-clusterissuer
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: r.6degrees.com.sa
    http:
      paths:
      - backend:
          service:
            name: rancher
            port:
              number: 80
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - r.6degrees.com.sa
    secretName: http01-clusterissuer-secret


// rancher/rancher.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rancher
  namespace: cattle-system
  labels:
    app: rancher
spec:
  replicas: 3
  selector:
    matchLabels:
      app: rancher
  template:
    metadata:
      labels:
        app: rancher
    spec:
      containers:
      - name: rancher
        image: rancher/rancher:v2.10.1
        args:
          - --http-listen-port=80
          - --https-listen-port=443
          - --add-local=true
          - --advertise-address=$(EXTERNAL_IP)
        env:
        - name: EXTERNAL_IP
          valueFrom:
            configMapKeyRef:
              name: external-lb-config
              key: external-ip


// rancher/service.yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    meta.helm.sh/release-name: rancher
    meta.helm.sh/release-namespace: cattle-system
  creationTimestamp: "2025-01-02T07:26:29Z"
  labels:
    app: rancher
    app.kubernetes.io/managed-by: Helm
    chart: rancher-2.10.1
    heritage: Helm
    release: rancher
  name: rancher
  namespace: cattle-system
  resourceVersion: "44798"
  uid: 430ba2ba-69e3-4f2c-9aef-fe969d2ccad1
spec:
  clusterIP: 10.128.42.219
  clusterIPs:
  - 10.128.42.219
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  - name: https-internal
    port: 443
    protocol: TCP
    targetPort: 444
  selector:
    app: rancher
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}


// rancher/values.yaml
USER-SUPPLIED VALUES:
bootstrapPassword: admin
hostname: n.basemalaraj.com
